<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email & PDF Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1, h2 { color: #111; }
        h1 { margin-bottom: 20px; }
        h2 { margin-bottom: 15px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .tab.active { background: #111; color: #fff; }
        .tab:hover:not(.active) { background: #f0f0f0; }
        .panel { display: none; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .panel.active { display: block; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-weight: 600; }
        .search { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #f9f9f9; padding: 15px; border-radius: 6px; text-align: center; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: #111; }
        .stat-card .label { font-size: 12px; color: #666; margin-top: 5px; }
        .empty { text-align: center; padding: 40px; color: #999; }
        .validator-section { max-width: 800px; margin: 40px auto; padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .upload-btn { background: #111; color: #fff; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .upload-btn:hover { background: #333; }
        .result-card { border-radius: 6px; padding: 15px; margin-bottom: 10px; }
        .result-card.valid { border: 1px solid #22c55e; background: #f0fdf4; }
        .result-card.corrupted { border: 1px solid #ef4444; background: #fef2f2; }
        .layer-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 10px; }
        .layer-box { text-align: center; padding: 8px; border-radius: 4px; font-size: 11px; }
        .layer-box.ok { background: #dcfce7; }
        .layer-box.fail { background: #fee2e2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Analytics Dashboard</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="value" id="total-deals">0</div>
                <div class="label">Active Deals</div>
            </div>
            <div class="stat-card">
                <div class="value" id="total-opens">0</div>
                <div class="label">Email Opens</div>
            </div>
            <div class="stat-card">
                <div class="value" id="total-views">0</div>
                <div class="label">PDF Views</div>
            </div>
            <div class="stat-card">
                <div class="value" id="total-downloads">0</div>
                <div class="label">PDF Downloads</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="validator">PDF Validator</div>
            <div class="tab" data-tab="opens">Email Opens</div>
            <div class="tab" data-tab="views">PDF Views</div>
            <div class="tab" data-tab="downloads">Downloads</div>
        </div>

        <!-- PDF Validator Panel -->
        <div class="panel active" id="validator-panel">
            <div class="validator-section">
                <h2>üîê PDF Integrity Checker</h2>
                <p style="color: #666; margin-bottom: 20px;">Upload encrypted PDFs to verify 6-layer integrity</p>
                
                <input type="file" id="pdfFiles" multiple accept=".pdf" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                <button onclick="checkPDFs()" class="upload-btn">Check Files</button>
                
                <div id="results" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div class="panel" id="opens-panel">
            <input type="text" class="search" placeholder="Filter..." id="opens-search">
            <table>
                <thead>
                    <tr>
                        <th>Deal ID</th>
                        <th>Business</th>
                        <th>Lender</th>
                        <th>Opened At</th>
                    </tr>
                </thead>
                <tbody id="opens-table"></tbody>
            </table>
        </div>

        <div class="panel" id="views-panel">
            <input type="text" class="search" placeholder="Filter..." id="views-search">
            <table>
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Deal ID</th>
                        <th>Lender</th>
                        <th>Viewed At</th>
                    </tr>
                </thead>
                <tbody id="views-table"></tbody>
            </table>
        </div>

        <div class="panel" id="downloads-panel">
            <input type="text" class="search" placeholder="Filter..." id="downloads-search">
            <table>
                <thead>
                    <tr>
                        <th>Token</th>
                        <th>Deal ID</th>
                        <th>Lender</th>
                        <th>Downloaded At</th>
                    </tr>
                </thead>
                <tbody id="downloads-table"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let emailOpens = [];
        let pdfViews = [];
        let pdfDownloads = [];

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
            });
        });

        // PDF Validator
        async function checkPDFs() {
            const files = document.getElementById('pdfFiles').files;
            if (!files.length) {
                alert('Please select PDF files');
                return;
            }
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Checking...</div>';
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch('/check-pdfs', {
                    method: 'POST',
                    body: formData
                });
                
                const results = await response.json();
                
                resultsDiv.innerHTML = results.map(r => `
                    <div class="result-card ${r.corrupted ? 'corrupted' : 'valid'}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${r.filename}</strong>
                            <span style="padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${r.corrupted ? '#ef4444' : '#22c55e'}; color: #fff;">
                                ${r.corrupted ? '‚ùå CORRUPTED' : '‚úÖ VALID'}
                            </span>
                        </div>
                        
                        <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
                            Layers: ${r.successful_layers}/6 ‚Ä¢ ${r.pdf_valid ? 'PDF Valid' : 'PDF Invalid'}
                        </div>
                        
                        <div class="layer-grid">
                            ${r.layers.map(layer => `
                                <div class="layer-box ${layer.status === 'OK' ? 'ok' : 'fail'}">
                                    <div style="font-weight: 600;">L${layer.layer}</div>
                                    <div>${layer.status === 'OK' ? '‚úì' : '‚úó'}</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${r.errors.length ? `
                            <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 4px; border-left: 3px solid #ef4444;">
                                <strong style="font-size: 12px; color: #dc2626;">Errors:</strong>
                                <ul style="margin: 5px 0 0 20px; font-size: 12px;">
                                    ${r.errors.map(e => `<li>Layer ${e.layer}: ${e.error}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `).join('');
                
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #ef4444; padding: 20px; text-align: center;">Error: ${error.message}</div>`;
            }
        }

        // Load data
        async function loadData() {
            const { data: opens } = await supabase.from('email_opens').select('*').order('opened_at', { ascending: false });
            const { data: views } = await supabase.from('pdf_views').select('*').order('id', { ascending: false });
            const { data: downloads } = await supabase.from('pdf_downloads').select('*').order('downloaded_at', { ascending: false });
            
            emailOpens = opens || [];
            pdfViews = views || [];
            pdfDownloads = downloads || [];
            
            document.getElementById('total-opens').textContent = emailOpens.length;
            document.getElementById('total-views').textContent = pdfViews.length;
            document.getElementById('total-downloads').textContent = pdfDownloads.length;
            
            // Render tables
            document.getElementById('opens-table').innerHTML = emailOpens.map(r => `
                <tr><td>${r.deal_id || '-'}</td><td>${r.business_name || '-'}</td><td>${r.lender_name || '-'}</td><td>${new Date(r.opened_at).toLocaleString()}</td></tr>
            `).join('') || '<tr><td colspan="4" class="empty">No data</td></tr>';
            
            document.getElementById('views-table').innerHTML = pdfViews.map(r => `
                <tr><td>${r.token || '-'}</td><td>${r.deal_id || '-'}</td><td>${r.lender_name || '-'}</td><td>${new Date(r.viewed_at || r.time).toLocaleString()}</td></tr>
            `).join('') || '<tr><td colspan="4" class="empty">No data</td></tr>';
            
            document.getElementById('downloads-table').innerHTML = pdfDownloads.map(r => `
                <tr><td>${r.token || '-'}</td><td>${r.deal_id || '-'}</td><td>${r.lender_name || '-'}</td><td>${new Date(r.downloaded_at).toLocaleString()}</td></tr>
            `).join('') || '<tr><td colspan="4" class="empty">No data</td></tr>';
        }

        loadData();
    </script>
</body>
</html>
